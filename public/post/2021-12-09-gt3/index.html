<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="google-site-verification" content="gvTIRAZF7KZCKm-syPBJcDj0JiQpJqR6f6uq6PCfZYs" />

        <meta property="og:title" content="Diagramme en barres empilées GT3" />
<meta property="og:description" content="Pour ce troisième post de la série GT-graphe type, intéressons-nous à un autre type de diagramme à bâtons, celui avec des barres empilées (stacked bar chart).Il s’agit d’un graphe dans lequel les barres ordinaires sont découpées en fonction de l’effectif de sous-catégories. Cela permet de mettre en évidence comment ces dernières contribuent à la valeur décrite par la barre dans laquelle elles sont inclues. On peut ainsi mettre en évidence dans un seul graphe à la fois les proportions relatives des sous-catégories et le totale des effectifs des catégories." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/2021-12-09-gt3/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-12-09T00:00:00+00:00" />


        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Diagramme en barres empilées GT3"/>
<meta name="twitter:description" content="Pour ce troisième post de la série GT-graphe type, intéressons-nous à un autre type de diagramme à bâtons, celui avec des barres empilées (stacked bar chart).Il s’agit d’un graphe dans lequel les barres ordinaires sont découpées en fonction de l’effectif de sous-catégories. Cela permet de mettre en évidence comment ces dernières contribuent à la valeur décrite par la barre dans laquelle elles sont inclues. On peut ainsi mettre en évidence dans un seul graphe à la fois les proportions relatives des sous-catégories et le totale des effectifs des catégories."/>
<meta name="twitter:site" content="@VigneronLudovic"/>

        
        <title>
  Diagramme en barres empilées GT3 | My Econ Tricks
</title>

        <link rel="icon" type="image/png" href='/images/favicon-16x16.png' sizes="16x16">
        <link rel="icon" type="image/png" href='/images/favicon-32x32.png' sizes="32x32">  

        <link href="https://fonts.googleapis.com/css?family=Oswald:400" rel="stylesheet">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">      
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
        
        
        
        

        <link rel="stylesheet" href="/css/bundle.min.3c1ab42be3f0635203d9e8bbe9cd3da817ca1d442ea586b8d8de6a4853e0d743.css" integrity="sha256-PBq0K&#43;PwY1ID2ei76c09qBfKHUQupYa42N5qSFPg10M="  />

        
    <link rel="me" type="text/html" href="https://twitter.com/VigneronLudovic"/> 
<link rel="me" type="text/html" href="https://www.linkedin.com/in/ludovic-vigneron-1ba27749/"/> 
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">

<link rel="alternate" type="application/rss+xml" href='/index.xml' />

<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="author" content="My Econ Tricks" />
<meta name="copyright" content="© Ludovic Vigneroin 2021–2022. All rights reserved." />
<meta name="google-site-verification" content="gvTIRAZF7KZCKm-syPBJcDj0JiQpJqR6f6uq6PCfZYs" />


<meta name="description" content="Pour ce troisième post de la série GT-graphe type, intéressons-nous à un autre type de diagramme à bâtons, celui avec des barres empilées (stacked bar chart).Il s’agit d’un graphe dans lequel les barres ordinaires sont découpées en fonction de l’effectif de sous-catégories. Cela permet de mettre en évidence comment ces dernières contribuent à la valeur décrite par la barre dans laquelle elles sont inclues. On peut ainsi mettre en évidence dans un seul graphe à la fois les proportions relatives des sous-catégories et le totale des effectifs des catégories.">


    
        
    </head>
    <body>
        <nav class="navbar fixed-top navbar-expand-md navbar-dark bg-dark py-1 top-nav">
            <div class="container">
                    <a class="navbar-brand pr-2" href="/">MY ECON TRICKS</a>
                <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="navbar-collapse collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item">
    <a class="nav-link active" href="/about/">A propos</a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="/categories/recherche/">Recherche</a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="/categories/datavisualisation/">Datavisualisation</a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="/categories/r/">R</a>
</li>

                    </ul>
                    <div class="social-icons d-none d-lg-block">
                        <a class="py-2 px-2" href="https://twitter.com/VigneronLudovic"><i class="fab fa-twitter"></i></a>
<a class="py-2 px-2" href="https://www.linkedin.com/in/ludovic-vigneron-1ba27749/"><i class="fab fa-linkedin"></i></a>
<a class="py-2 px-2" href='/index.xml'><i class="fas fa-rss"></i></a>

                    </div>
                </div>
            </div>
        </nav>

        
<header class="feature-image d-print-none">
</header>

        
        <div class="main">
            
<div class="container mt-4 post">
    <h1>Diagramme en barres empilées GT3</h1>
    <div class="mb-3">
    <small>
        <strong>By Ludovic Vigneron</strong>
        | <i class="far fa-calendar-alt"></i>&nbsp;Dec 9, 2021&nbsp;
        | <i class="fa fa-tags" title="Tags" aria-hidden="true"></i> <a href='/tags/dataviz/'>dataviz</a>, <a href='/tags/ggplot2/'>ggplot2</a>, <a href='/tags/r/'>r</a>
    </small>
</div>

    <div class="share-icons d-flex justify-content-center d-print-none">
        <a href="https://twitter.com/intent/tweet?url=%2fpost%2f2021-12-09-gt3%2f&text=Diagramme%20en%20barres%20empil%c3%a9es%20GT3&tw_p=tweetbutton" class="p-2" title="Share on Twitter" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Tweet</small></div>
</a>

<a href="https://www.facebook.com/sharer.php?u=%2fpost%2f2021-12-09-gt3%2f&t=Diagramme%20en%20barres%20empil%c3%a9es%20GT3" class="p-2" title="Share on Facebook" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Share</small></div>
</a>

<a href="https://www.linkedin.com/shareArticle?mini=true&url=%2fpost%2f2021-12-09-gt3%2f&title=Diagramme%20en%20barres%20empil%c3%a9es%20GT3&source=mattbutton.com" class="p-2" title="Share on LinkedIn" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Share</small></div>
</a>

<a href="javascript:window.print()" title="Print this article" class="p-2" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fa fa-print fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Print</small></div>
</a>
    </div>

    <div class="mt-4 mb-4 main-content">
        
<script src="/post/2021-12-09-gt3/index_files/header-attrs/header-attrs.js"></script>


<p><strong>Pour ce troisième post de la série GT-graphe type, intéressons-nous à un autre type de diagramme à bâtons, celui avec des barres empilées (stacked bar chart).Il s’agit d’un graphe dans lequel les barres ordinaires sont découpées en fonction de l’effectif de sous-catégories. Cela permet de mettre en évidence comment ces dernières contribuent à la valeur décrite par la barre dans laquelle elles sont inclues. On peut ainsi mettre en évidence dans un seul graphe à la fois les proportions relatives des sous-catégories et le totale des effectifs des catégories. Cela multiplie les possibilités comparaisons. C’est là qu’il faut être prudent. S’il y a trop de sous-catégories, le graphe devient vite illisible. On se limitera dans l’idéal à trois ou quatre. Par ailleurs, une seule de ces sous-catégories ne sera accolée à l’origine et donc offrira une base de comparaison rapide et fiable entre les différentes catégories (barres). Il est conseillé d’y placer celle qui vous intéresse le plus. Vous pouvez également jouer sur les couleurs et/ou les valeurs (plus ou moins sombre) pour renforcer sa mise en avant.</strong></p>
<p>Voyons comment en réaliser un à la fois parlant et élégant avec GGPLOT2. Pour cela, travaillons encore une fois avec la base utilisée dans le post précédent: le décompte de la population rurale et urbaine dans le monde sur différentes zones géographiques. Elles peuvent être téléchargées <a href="https://population.un.org/wup/Download/Files/WUP2018-F01-Total_Urban_Rural.xls">ici</a>.</p>
<p>Mais avant d’aller plus loin, chargeons quelques packages qui seront utiles par la suite: le tidyverser (pour les manipulations de données et GGPLOT), readxl (pour lire le fichier de données), scales (pour la mise en forme des axes), ggtext (pour la mise en forme d’éléments textuels) et formattable (pour la mise en forme de valeurs numériques intégrées au graphe). Si ce n’est pas déjà fait, installez-les.</p>
<pre class="r"><code>library(tidyverse)
library(readxl)
library(scales)
library(ggtext)
library(formattable)</code></pre>
<p>On peut maintenant charger les données et commencer la mise en forme. Limitons la base aux différents continents. Mettons la base dans le bon sens et traduisons en français les éléments textuels en intégrant des alinéas pour les intitulés longs (qui seront intégrés grâce à ggtext).</p>
<pre class="r"><code>dat &lt;- read_excel(&quot;WUP2018-F01-Total_Urban_Rural.xls&quot;,skip = 16) %&gt;% 
       select(`Region, subregion, country or area`,Urban,Rural) %&gt;% 
               rename(Reg=`Region, subregion, country or area`) %&gt;% 
       filter(Reg%in%c(&#39;AFRICA&#39;,&#39;ASIA&#39;,&#39;EUROPE&#39;,
                       &#39;LATIN AMERICA AND THE CARIBBEAN&#39;,&#39;NORTHERN AMERICA&#39;,
                       &#39;OCEANIA&#39;)) %&gt;% 
    pivot_longer(cols=c(Urban,Rural),names_to=&#39;type&#39;) %&gt;% 
    mutate(type=ifelse(type==&quot;Rural&quot;,&quot;Rurale&quot;,&quot;Urbaine&quot;),
                    Reg=ifelse(Reg==&quot;AFRICA&quot;,&quot;Afrique&quot;,
                        ifelse(Reg==&quot;ASIA&quot;,&quot;Asie&quot;,
                        ifelse(Reg==&quot;EUROPE&quot;,&quot;Europe&quot;,
                        ifelse(Reg==&quot;LATIN AMERICA AND THE CARIBBEAN&quot;,
                               &quot;Amérique latine
  et Caraïbes&quot;,
                        ifelse(Reg==&quot;NORTHERN AMERICA&quot;,
                               &quot;Amérique
  du nord&quot;,&quot;Océanie&quot;))))))
dat</code></pre>
<pre><code>## # A tibble: 12 x 3
##    Reg                              type       value
##    &lt;chr&gt;                            &lt;chr&gt;      &lt;dbl&gt;
##  1 &quot;Afrique&quot;                        Urbaine  547602.
##  2 &quot;Afrique&quot;                        Rurale   740318.
##  3 &quot;Asie&quot;                           Urbaine 2266131.
##  4 &quot;Asie&quot;                           Rurale  2279003.
##  5 &quot;Europe&quot;                         Urbaine  552911.
##  6 &quot;Europe&quot;                         Rurale   189737.
##  7 &quot;Amérique latine\n  et Caraïbes&quot; Urbaine  526057.
##  8 &quot;Amérique latine\n  et Caraïbes&quot; Rurale   125955.
##  9 &quot;Amérique\n  du nord&quot;            Urbaine  298987.
## 10 &quot;Amérique\n  du nord&quot;            Rurale    64857.
## 11 &quot;Océanie&quot;                        Urbaine   28129.
## 12 &quot;Océanie&quot;                        Rurale    13132.</code></pre>
<p>On pourrait à partir de là établir de simples diagrammes à bâtons pour les zonez rurales et urbaines…</p>
<pre class="r"><code>ggplot(dat,aes(x=Reg,y=value))+
  geom_bar(stat = &quot;identity&quot;)+
  facet_wrap(.~type)+
  theme(axis.text.x = element_text(angle=90))</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>… voir un diagramme pairé.</p>
<pre class="r"><code>ggplot(dat,aes(x=Reg,y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;,position=&#39;dodge&#39;)+
  theme(axis.text.x = element_text(angle=90))</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>Mais ce n’est pas ce qui nous intéresse ici. On veut des barres empilées. Une des manières de les envisager est de leurs données une taille commune représentant 100% des observations des catégories considérées. Cela permet de bien distinguer l’importance des sous-groupes (rurale contre urbain) pour chacune d’elles.</p>
<pre class="r"><code>ggplot(dat,aes(x=Reg,y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;,
           position=&#39;fill&#39;)+
  theme(axis.text.x = element_text(angle=90))</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>Néanmoins en procédant de la sorte, nous perdons l’information sur la taille des groupe. Pour la garder, supprimons dans le geom_bar() l’option position.</p>
<pre class="r"><code>ggplot(dat,aes(x=Reg,y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;)+
  theme(axis.text.x = element_text(angle=90))</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>C’est ce graphe que nous retiendrons comme base de travail. Voyons comment l’améliorer. Commençons par mettre l’ensemble à l’horizontale et optons pour un thème plus neutre.</p>
<pre class="r"><code>ggplot(dat,aes(x=Reg,y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;)+
  coord_flip()+
  theme_minimal()</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Modifions les titres des axes et ajoutons un titre générale ainsi qu’une caption pour indiquer la source des données.</p>
<pre class="r"><code>ggplot(dat,aes(x=Reg,y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;)+
  labs(title=&quot;Population urbaine c. rurale par continents en 2018&quot;,
       caption=&quot;Source: United Nations, Department of Economic and Social Affairs, World Urbanization Prospects&quot;,
    x=&#39;Régions&#39;,y=&#39;Population (en milliers)&#39;)+
  coord_flip()+
  theme_minimal()</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>Réduisons l’épaisseur des barres et changeons leur couleurs pour reprendre celles que nous avons utilisées dans le post précédent (le jaune #F1D739 et le bleu #399CF1).</p>
<pre class="r"><code>ggplot(dat,aes(x=Reg,y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;,width = 0.6)+
  labs(title=&quot;Population urbaine c. rurale par continents en 2018&quot;,
       caption=&quot;Source: United Nations, Department of Economic and Social Affairs, World Urbanization Prospects&quot;,
    x=&#39;Régions&#39;,y=&#39;Population (en milliers)&#39;)+
  coord_flip()+
  scale_fill_manual(values=c(&#39;#F1D739&#39;,&#39;#399CF1&#39;))+
  theme_minimal()</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>Mettons en forme le titre (centré) et le caption (italic justifié à droite).</p>
<pre class="r"><code>ggplot(dat,aes(x=Reg,y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;,width = 0.6)+
  labs(title=&quot;Population urbaine c. rurale par continents en 2018&quot;,
       caption=&quot;Source: United Nations, Department of Economic and Social Affairs, World Urbanization Prospects&quot;,
    x=&#39;Régions&#39;,y=&#39;Population (en milliers)&#39;)+
  coord_flip()+
  scale_fill_manual(values=c(&#39;#F1D739&#39;,&#39;#399CF1&#39;))+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5) ,
        plot.caption = element_text(hjust = 1, face=&#39;italic&#39;,size = 6))</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>Ramenons la légende dans le graphe et supprimons son titre.</p>
<pre class="r"><code>ggplot(dat,aes(x=Reg,y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;,width = 0.6)+
  labs(title=&quot;Population urbaine c. rurale par continents en 2018&quot;,
       caption=&quot;Source: United Nations, Department of Economic and Social Affairs, World Urbanization Prospects&quot;,
    x=&#39;Régions&#39;,y=&#39;Population (en milliers)&#39;)+
  coord_flip()+
  scale_fill_manual(values=c(&#39;#F1D739&#39;,&#39;#399CF1&#39;))+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5) ,
        plot.caption = element_text(hjust = 1, face=&#39;italic&#39;,size = 6),
        legend.position = c(0.85, 0.15),
        legend.title = element_blank())</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>Ramenons le titre de l’axe des continents en haut, alignons les noms des continents sur la gauche et réduisons les marges du graphe.</p>
<pre class="r"><code>ggplot(dat,aes(x=Reg,y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;,width = 0.6)+
  labs(title=&quot;Population urbaine c. rurale par continents en 2018&quot;,
       caption=&quot;Source: United Nations, Department of Economic and Social Affairs, World Urbanization Prospects&quot;,
    x=&#39;Régions&#39;,y=&#39;Population (en milliers)&#39;)+
  coord_flip(expand=FALSE)+
  scale_fill_manual(values=c(&#39;#F1D739&#39;,&#39;#399CF1&#39;))+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5) ,
        plot.caption = element_text(hjust = 1, face=&#39;italic&#39;,size = 6),
        axis.title.y=element_text(hjust=1, angle=0,margin = margin(r=-35)),
        axis.text.y = element_text(hjust=0),
        legend.position = c(0.85, 0.15),
        legend.title = element_blank())</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>Mettons en forme les étiquettes de l’axe population en utilisant la fonction <strong>unit_format()</strong> du package scale.</p>
<pre class="r"><code>ggplot(dat,aes(x=Reg,y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;,width = 0.6)+
  labs(title=&quot;Population urbaine c. rurale par continents en 2018&quot;,
       caption=&quot;Source: United Nations, Department of Economic and Social Affairs, World Urbanization Prospects&quot;,
    x=&#39;Régions&#39;,y=&#39;Population (en milliers)&#39;)+
  coord_flip(expand=FALSE)+
  scale_fill_manual(values=c(&#39;#F1D739&#39;,&#39;#399CF1&#39;))+
  scale_y_continuous(labels = unit_format(unit = &quot;M&quot;,scale = 1e-3))+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5) ,
        plot.caption = element_text(hjust = 1, face=&#39;italic&#39;,size = 6),
        axis.title.y=element_text(hjust=1, angle=0,margin = margin(r=-35)),
        axis.text.y = element_text(hjust=0),
        legend.position = c(0.85, 0.15),
        legend.title = element_blank())</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>Etendons le graphe de sortie (4.5 pouces de haut et 8.5 pouces de large). Supprimons la grille à l’arrière et ajoutons à l’extrémité des barres les effectifs globaux pour chaque continent. Pour cela, utilisons le <strong>geom_text()</strong>. Indiquons que l’on utilisera comme label une statistique issue des ordonnées y (des abscisses dans le graphe retourné) que cette statistique est descriptive (summary) construit sur la fonction sum (pour somme).</p>
<pre class="r"><code>ggplot(dat,aes(x=Reg,y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;,width = 0.6)+
  geom_text(aes(label =stat(y),group=factor(Reg)),
            stat = &#39;summary&#39;, fun = sum, hjust = -0.1,
              size=3)+
  labs(title=&quot;Population urbaine c. rurale par continents en 2018&quot;,
       caption=&quot;Source: United Nations, Department of Economic and Social Affairs, World Urbanization Prospects&quot;,
    x=&#39;Régions&#39;,y=&#39;Population (en milliers)&#39;)+
  coord_flip(expand=FALSE,ylim=c(0,5100000))+
  scale_fill_manual(values=c(&#39;#F1D739&#39;,&#39;#399CF1&#39;))+
  scale_y_continuous(labels = unit_format(unit = &quot;M&quot;,scale = 1e-3))+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5) ,
        plot.caption = element_text(hjust = 1, face=&#39;italic&#39;,size = 6),
        axis.title.y=element_text(hjust=1, angle=0,margin = margin(r=-35)),
        axis.text.y = element_text(hjust=0),
        panel.grid = element_blank(),
        legend.position = c(0.85, 0.15),
        legend.title = element_blank())</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-14-1.png" width="816" /></p>
<p>Notez que les valeurs portées à l’extrémité des barres ne sont pas très lisible. Améliorons cela en utilisant la fonction <strong>comma()</strong> sur package formattable. Indiquons que l’on ne veut que des valleurs entière (digits=0) et que le séparateur des milliers (big.mark) sera un simple espace.</p>
<pre class="r"><code>ggplot(dat,aes(x=Reg,y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;,width = 0.6)+
  geom_text(aes(label =comma(stat(y),digits=0,
                             big.mark = &#39; &#39;),group=factor(Reg)),
            stat = &#39;summary&#39;, fun = sum, hjust = -0.1,
              size=3)+
  labs(title=&quot;Population urbaine c. rurale par continents en 2018&quot;,
       caption=&quot;Source: United Nations, Department of Economic and Social Affairs, World Urbanization Prospects&quot;,
    x=&#39;Régions&#39;,y=&#39;Population (en milliers)&#39;)+
  coord_flip(expand=FALSE,ylim=c(0,5100000))+
  scale_fill_manual(values=c(&#39;#F1D739&#39;,&#39;#399CF1&#39;))+
  scale_y_continuous(labels = unit_format(unit = &quot;M&quot;,scale = 1e-3))+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5) ,
        plot.caption = element_text(hjust = 1, face=&#39;italic&#39;,size = 6),
        axis.title.y=element_text(hjust=1, angle=0,margin = margin(r=-35)),
        axis.text.y = element_text(hjust=0),
        panel.grid = element_blank(),
        legend.position = c(0.85, 0.15),
        legend.title = element_blank())</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-15-1.png" width="816" /></p>
<p>Le graphe serait plus parlant si la catégorie à l’effective le plus grand venait en premier. Créons une variable (tot) à cette fin et utilisons la pour classer nos continents.</p>
<pre class="r"><code>dat&lt;-dat %&gt;% group_by(Reg) %&gt;% mutate(tot=sum(value))</code></pre>
<p>Passons la variable Reg en facteur et utilisons la fonctions <strong>reorder()</strong> pour établir l’ordre des valeurs en fonction de tot.</p>
<pre class="r"><code>ggplot(dat,aes(x=reorder(factor(Reg),tot),y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;,width = 0.6)+
  geom_text(aes(label =comma(stat(y),digits=0,big.mark = &#39; &#39;),group=Reg),
            stat = &#39;summary&#39;, fun = sum, hjust = -0.1,size=3)+
  labs(title=&quot;Population urbaine c. rurale par continents en 2018&quot;,
       caption=&quot;Source: United Nations, Department of Economic and Social Affairs, World Urbanization Prospects&quot;,
    x=&#39;Régions&#39;,y=&#39;Population (en milliers)&#39;)+
  coord_flip(expand=FALSE,ylim=c(0,5100000))+
  scale_fill_manual(values=c(&#39;#F1D739&#39;,&#39;#399CF1&#39;))+
  scale_y_continuous(labels = unit_format(unit = &quot;M&quot;,scale = 1e-3))+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5) ,
        plot.caption = element_text(hjust = 1, face=&#39;italic&#39;,size = 6),
        axis.title.y=element_text(hjust=1, angle=0,margin = margin(r=-35)),
        axis.text.y = element_text(hjust=0),
        panel.grid = element_blank(),
        legend.position = c(0.85, 0.15),
        legend.title = element_blank())</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-17-1.png" width="816" /></p>
<p>Pour finaliser, le graphe on peut ajouter la part en pourcentage de la population urbaine dans les barres de chaque continent. Calculons cette variable.</p>
<pre class="r"><code>dat &lt;- dat %&gt;% group_by(Reg) %&gt;% 
  mutate(perc=round(value/tot*100),
         perc_urb=ifelse(type==&#39;Urbaine&#39;,paste(perc,&#39;%&#39;),&#39;&#39;))</code></pre>
<p>Ceci fait. Intégrons un nouveau <strong>geom_text()</strong>.</p>
<pre class="r"><code>ggplot(dat,aes(x=reorder(factor(Reg),tot),y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;,width = 0.6)+
  geom_text(aes(label =comma(stat(y),digits=0,big.mark = &#39; &#39;),group=Reg),
            stat = &#39;summary&#39;, fun = sum, hjust = -0.1,size=3)+
  geom_text(aes(label = perc_urb), hjust = 1.5,
            position = position_stack(0.99),size=3,color=&#39;white&#39;)+
  labs(title=&quot;Population urbaine c. rurale par continents en 2018&quot;,
       caption=&quot;Source: United Nations, Department of Economic and Social Affairs, World Urbanization Prospects&quot;,
    x=&#39;Régions&#39;,y=&#39;Population (en milliers)&#39;)+
  coord_flip(expand=FALSE,ylim=c(0,5100000))+
  scale_fill_manual(values=c(&#39;#F1D739&#39;,&#39;#399CF1&#39;))+
  scale_y_continuous(labels = unit_format(unit = &quot;M&quot;,scale = 1e-3))+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5) ,
        plot.caption = element_text(hjust = 1, face=&#39;italic&#39;,size = 6),
        axis.title.y=element_text(hjust=1, angle=0,margin = margin(r=-35)),
        axis.text.y = element_text(hjust=0),
        panel.grid = element_blank(),
        legend.position = c(0.85, 0.15),
        legend.title = element_blank())</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-19-1.png" width="816" /></p>
<p>Nous avons un soucis avec l’Océanie. La proportion n’apparaît pas parce que la barre qui lui est attribuée est trop petite. Reportant sa valeur (68 %) après le total de la population en Océanie en reprenant le bleu (#399CF1) associé à la fraction urbaine.</p>
<pre class="r"><code>ggplot(dat,aes(x=reorder(factor(Reg),tot),y=value,fill=type))+
  geom_bar(stat = &quot;identity&quot;,width = 0.6)+
  geom_text(aes(label =comma(stat(y),digits=0,big.mark = &#39; &#39;),group=Reg),
            stat = &#39;summary&#39;, fun = sum, hjust = -0.1,size=3)+
  geom_text(aes(label = perc_urb), hjust = 1.5,
            position = position_stack(0.99),size=3,color=&#39;white&#39;)+
  geom_text(aes(x=&#39;Océanie&#39;,y=500000,label=&#39;68%&#39;),size=3,
            color=&#39;#399CF1&#39;)+
  labs(title=&quot;Population urbaine c. rurale par continents en 2018&quot;,
       caption=&quot;Source: United Nations, Department of Economic and Social Affairs, World Urbanization Prospects&quot;,
    x=&#39;Régions&#39;,y=&#39;Population (en milliers)&#39;)+
  coord_flip(expand=FALSE,ylim=c(0,5100000))+
  scale_fill_manual(values=c(&#39;#F1D739&#39;,&#39;#399CF1&#39;))+
  scale_y_continuous(labels = unit_format(unit = &quot;M&quot;,scale = 1e-3))+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5) ,
        plot.caption = element_text(hjust = 1, face=&#39;italic&#39;,size = 6),
        axis.title.y=element_text(hjust=1, angle=0,margin = margin(r=-35)),
        axis.text.y = element_text(hjust=0),
        panel.grid = element_blank(),
        legend.position = c(0.85, 0.15),
        legend.title = element_blank())</code></pre>
<p><img src="/post/2021-12-09-gt3/index_files/figure-html/unnamed-chunk-20-1.png" width="816" /></p>
<p>Je pense que l’on peut s’arrêter là sur la mise en forme. Nous avons un graphe à la fois parlant et esthétique. Le tout est obtenu avec un minimum de code. Pour l’écriture de ce dernier, je n’aurais que deux conseils. Le premier est simple: progresser étape par étape, transformation par transformation… Le second est de conserver une structure lisible et constante. Pour ma part, il s’agit de données, geom (dans l’ordre de ce qui est important de voir sur le graphe), labs, coordonnées, échelles, thème et éléments de thème.</p>


        <div class="share-icons d-flex justify-content-center d-print-none">
            <a href="https://twitter.com/intent/tweet?url=%2fpost%2f2021-12-09-gt3%2f&text=Diagramme%20en%20barres%20empil%c3%a9es%20GT3&tw_p=tweetbutton" class="p-2" title="Share on Twitter" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Tweet</small></div>
</a>

<a href="https://www.facebook.com/sharer.php?u=%2fpost%2f2021-12-09-gt3%2f&t=Diagramme%20en%20barres%20empil%c3%a9es%20GT3" class="p-2" title="Share on Facebook" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Share</small></div>
</a>

<a href="https://www.linkedin.com/shareArticle?mini=true&url=%2fpost%2f2021-12-09-gt3%2f&title=Diagramme%20en%20barres%20empil%c3%a9es%20GT3&source=mattbutton.com" class="p-2" title="Share on LinkedIn" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Share</small></div>
</a>

<a href="javascript:window.print()" title="Print this article" class="p-2" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fa fa-print fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Print</small></div>
</a>
        </div>
    </div>

    
</div>
<div class="sidebar d-print-none d-none d-xl-block">
    
        <h2>My Econ Tricks</h2>
        <div>
            Blog académique tenu par Ludovic Vigneron, docteur en Finance et, depuis un certain nombre d&#39;années, Maître de Conférences à l&#39;Université Polytechnique Hauts de France.
        </div>
        <a href='/about/' class="btn btn-outline-secondary mt-3" role="button">Read More...</a>
        <h2 class="mt-4">Top Posts</h2>
    
    
    <h2 class="mt-4">Posts recents</h2>
    <nav class="nav flex-column">
        
        <a href="/post/2022-05-26-ttrer/" class="nav-link">ttrer</a>
        
        <a href="/post/2022-05-23-le-diagramme-en-chute-d-eau-gt12/" class="nav-link">Le diagramme en chute d&#39;eau GT12</a>
        
        <a href="/post/2022-05-10-le-diagramme-de-sankey-gt11/" class="nav-link">Le diagramme de Sankey GT11</a>
        
        <a href="/post/2022-05-05-bulles-de-comparaison-et-bulle-intriqu-e-gt10/" class="nav-link">Bulles de comparaison et bulle intriquée GT10</a>
        
        <a href="/post/2022-04-17-bullet-chart-et-gauge-chart-gt-9/" class="nav-link">Bullet chart et gauge chart GT9</a>
        
        <a href="/post/2022-04-10-test/" class="nav-link">Les heatmap et les calendar heatmap GT8</a>
        
        <a href="/post/2022-03-25-mes-premieres-videos-de-codage-de-graphes/" class="nav-link">Mes premieres videos de codage de graphes</a>
        
        <a href="/post/2022-04-29-les-diagramme-en-gaufre-et-les-isotypes-gt7/" class="nav-link">Les diagrammes en gaufre et les isotypes GT7</a>
        
    </nav>
    
    <h2 class="mt-4 text-capitalize">categories</h2>
    <nav class="nav flex-column">
        
        <a href='/categories/datavisualisation/' class="nav-link">
        datavisualisation
        <span class="badge badge-pill badge-secondary">19</span>
        </a>
        
        <a href='/categories/r/' class="nav-link">
        r
        <span class="badge badge-pill badge-secondary">16</span>
        </a>
        
        <a href='/categories/ggplot2/' class="nav-link">
        ggplot2
        <span class="badge badge-pill badge-secondary">6</span>
        </a>
        
        <a href='/categories/dataviz/' class="nav-link">
        dataviz
        <span class="badge badge-pill badge-secondary">2</span>
        </a>
        
        <a href='/categories/analysis/' class="nav-link">
        analysis
        <span class="badge badge-pill badge-secondary">1</span>
        </a>
        
        <a href='/categories/mathematique/' class="nav-link">
        mathematique
        <span class="badge badge-pill badge-secondary">1</span>
        </a>
        
        <a href='/categories/recherche/' class="nav-link">
        recherche
        <span class="badge badge-pill badge-secondary">1</span>
        </a>
        
        <a href='/categories/software-development/' class="nav-link">
        software-development
        <span class="badge badge-pill badge-secondary">1</span>
        </a>
        
    </nav>
    
    <h2 class="mt-4 text-capitalize">tags</h2>
    <nav class="nav flex-column">
        
        <a href='/tags/dataviz/' class="nav-link">
        dataviz
        <span class="badge badge-pill badge-secondary">19</span>
        </a>
        
        <a href='/tags/ggplot2/' class="nav-link">
        ggplot2
        <span class="badge badge-pill badge-secondary">17</span>
        </a>
        
        <a href='/tags/r/' class="nav-link">
        r
        <span class="badge badge-pill badge-secondary">11</span>
        </a>
        
        <a href='/tags/climat/' class="nav-link">
        climat
        <span class="badge badge-pill badge-secondary">3</span>
        </a>
        
        <a href='/tags/analysis/' class="nav-link">
        analysis
        <span class="badge badge-pill badge-secondary">1</span>
        </a>
        
        <a href='/tags/crowdfunding/' class="nav-link">
        crowdfunding
        <span class="badge badge-pill badge-secondary">1</span>
        </a>
        
        <a href='/tags/exercice/' class="nav-link">
        exercice
        <span class="badge badge-pill badge-secondary">1</span>
        </a>
        
        <a href='/tags/mathematic/' class="nav-link">
        mathematic
        <span class="badge badge-pill badge-secondary">1</span>
        </a>
        
        <a href='/tags/plotly/' class="nav-link">
        plotly
        <span class="badge badge-pill badge-secondary">1</span>
        </a>
        
        <a href='/tags/publication/' class="nav-link">
        publication
        <span class="badge badge-pill badge-secondary">1</span>
        </a>
        
    </nav>
    
</div>

        </div>

        <footer class="mt-auto footer d-print-none">
            <div class="container-fluid">
                <div class="row justify-content-center">
                    <div class="col-md-4 col-xl-3">
                        <h5>© Ludovic Vigneroin 2021–2022. All rights reserved.</h5>
Content on this site is licensed under a Creative Commons Attribution 4.0 International license.
                    </div>
                    <div class="col-md-4 col-xl-3">
                        <h5>Disclaimer</h5>
Opinions expressed here are my own and may not reflect those of the company I work for, or the people I work with.
                    </div>
                    <div class="col-md-4 col-xl-3">
                        <h5>About This Site</h5>
This blog was created using the <a href="https://gohugo.io/">Hugo</a> static site generator, using
<a href="https://getbootstrap.com/">Bootstrap</a>, using the Silhouette Hugo theme, created by
<a href='https://www.mattbutton.com'>Matt Button</a>


    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
    
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    
                    </div>
                </div>

                <hr />

                <div class="d-flex justify-content-center icons">
                    <a class="py-2 px-2" href="https://twitter.com/VigneronLudovic"><i class="fab fa-twitter"></i></a>
<a class="py-2 px-2" href="https://www.linkedin.com/in/ludovic-vigneron-1ba27749/"><i class="fab fa-linkedin"></i></a>
<a class="py-2 px-2" href='/index.xml'><i class="fas fa-rss"></i></a>

                </div>
            </div>
        </footer>

        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

        
    </body>
</html>
